!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@antv/g-lite")):"function"==typeof define&&define.amd?define(["exports","@antv/g-lite"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).G=e.G||{},e.G.CanvasRenderer={}),e.window.G)}(this,(function(e,t){"use strict";var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},r(e,t)};function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+t+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var i=function(){return i=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},i.apply(this,arguments)};function o(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a}var a=function(e){return null==e},l={}.toString,s=function(e,t){return l.call(e)==="[object "+t+"]"},c="undefined"!=typeof Float32Array?Float32Array:Array;function h(){var e=new c(16);return c!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function d(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function u(e,t,r){var n=t[0],i=t[1],o=t[2],a=t[3],l=t[4],s=t[5],c=t[6],h=t[7],d=t[8],u=t[9],p=t[10],f=t[11],v=t[12],y=t[13],g=t[14],m=t[15],A=r[0],x=r[1],b=r[2],S=r[3];return e[0]=A*n+x*l+b*d+S*v,e[1]=A*i+x*s+b*u+S*y,e[2]=A*o+x*c+b*p+S*g,e[3]=A*a+x*h+b*f+S*m,e[4]=(A=r[4])*n+(x=r[5])*l+(b=r[6])*d+(S=r[7])*v,e[5]=A*i+x*s+b*u+S*y,e[6]=A*o+x*c+b*p+S*g,e[7]=A*a+x*h+b*f+S*m,e[8]=(A=r[8])*n+(x=r[9])*l+(b=r[10])*d+(S=r[11])*v,e[9]=A*i+x*s+b*u+S*y,e[10]=A*o+x*c+b*p+S*g,e[11]=A*a+x*h+b*f+S*m,e[12]=(A=r[12])*n+(x=r[13])*l+(b=r[14])*d+(S=r[15])*v,e[13]=A*i+x*s+b*u+S*y,e[14]=A*o+x*c+b*p+S*g,e[15]=A*a+x*h+b*f+S*m,e}function p(){var e=new c(3);return c!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function f(e,t,r){var n=t[0],i=t[1],o=t[2],a=r[3]*n+r[7]*i+r[11]*o+r[15];return e[0]=(r[0]*n+r[4]*i+r[8]*o+r[12])/(a=a||1),e[1]=(r[1]*n+r[5]*i+r[9]*o+r[13])/a,e[2]=(r[2]*n+r[6]*i+r[10]*o+r[14])/a,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),p();var v=function(){function e(e){this.canvasRendererPluginOptions=e,this.removedRBushNodeAABBs=[],this.renderQueue=[],this.restoreStack=[],this.clearFullScreenLastFrame=!1,this.clearFullScreen=!1,this.vpMatrix=h(),this.dprMatrix=h(),this.tmpMat4=h(),this.vec3a=p(),this.vec3b=p(),this.vec3c=p(),this.vec3d=p()}return e.prototype.apply=function(r,n){var i=this;this.context=r;var a=r.config,l=r.camera,s=r.renderingService,c=r.renderingContext,h=r.pathGeneratorFactory;this.rBush=r.rBushRoot,this.pathGeneratorFactory=h;var d=r.contextService,p=c.root.ownerDocument.defaultView,v=function(e){var t=e.target.rBushNode;t.aabb&&i.removedRBushNodeAABBs.push(t.aabb)},y=function(e){var t=e.target.rBushNode;t.aabb&&i.removedRBushNodeAABBs.push(t.aabb)};s.hooks.init.tap(e.tag,(function(){p.addEventListener(t.ElementEvent.UNMOUNTED,v),p.addEventListener(t.ElementEvent.CULLED,y);var e=d.getDPR(),r=a.width,n=a.height,o=d.getContext();i.clearRect(o,0,0,r*e,n*e,a.background)})),s.hooks.destroy.tap(e.tag,(function(){p.removeEventListener(t.ElementEvent.UNMOUNTED,v),p.removeEventListener(t.ElementEvent.CULLED,y),i.renderQueue=[],i.removedRBushNodeAABBs=[],i.restoreStack=[]})),s.hooks.beginFrame.tap(e.tag,(function(){var e,t=d.getContext(),r=d.getDPR(),n=a.width,o=a.height,l=i.canvasRendererPluginOptions,c=l.dirtyObjectNumThreshold,h=l.dirtyObjectRatioThreshold,u=s.getStats(),f=u.rendered,v=f/u.total;i.clearFullScreen=i.clearFullScreenLastFrame||!(null===(e=p.context.renderingPlugins[1])||void 0===e?void 0:e.isFirstTimeRenderingFinished)||s.disableDirtyRectangleRendering()||f>c&&v>h,t&&(t.resetTransform?t.resetTransform():t.setTransform(1,0,0,1,0,0),i.clearFullScreen&&i.clearRect(t,0,0,n*r,o*r,a.background))}));var g=function(e,t){e.isVisible()&&!e.isCulled()&&i.renderDisplayObject(e,t,i.context,i.restoreStack,n),(e.sortable.sorted||e.childNodes).forEach((function(e){g(e,t)}))};s.hooks.endFrame.tap(e.tag,(function(){if(0!==c.root.childNodes.length){i.clearFullScreenLastFrame=!1;var e,r,s=d.getContext(),h=d.getDPR();if((e=i.dprMatrix)[0]=(r=[h,h,1])[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=r[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,u(i.vpMatrix,i.dprMatrix,l.getOrthoMatrix()),i.clearFullScreen)g(c.root,s);else{var v=i.safeMergeAABB.apply(i,function(e,t,r){if(r||2===arguments.length)for(var n,i=0,o=t.length;o>i;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))}([i.mergeDirtyAABBs(i.renderQueue)],o(i.removedRBushNodeAABBs.map((function(e){var r=e.minX,n=e.minY,i=e.maxX,o=e.maxY,a=new t.AABB;return a.setMinMax([r,n,0],[i,o,0]),a}))),!1));if(i.removedRBushNodeAABBs=[],t.AABB.isEmpty(v))return void(i.renderQueue=[]);var y=i.convertAABB2Rect(v),m=y.x,A=y.y,x=y.width,b=y.height,S=f(i.vec3a,[m,A,0],i.vpMatrix),B=f(i.vec3b,[m+x,A,0],i.vpMatrix),M=f(i.vec3c,[m,A+b,0],i.vpMatrix),R=f(i.vec3d,[m+x,A+b,0],i.vpMatrix),w=Math.min(S[0],B[0],R[0],M[0]),O=Math.min(S[1],B[1],R[1],M[1]),E=Math.max(S[0],B[0],R[0],M[0]),P=Math.max(S[1],B[1],R[1],M[1]),T=Math.floor(w),C=Math.floor(O),N=Math.ceil(E-w),L=Math.ceil(P-O);s.save(),i.clearRect(s,T,C,N,L,a.background),s.beginPath(),s.rect(T,C,N,L),s.clip(),s.setTransform(i.vpMatrix[0],i.vpMatrix[1],i.vpMatrix[4],i.vpMatrix[5],i.vpMatrix[12],i.vpMatrix[13]),a.renderer.getConfig().enableDirtyRectangleRenderingDebug&&p.dispatchEvent(new t.CustomEvent(t.CanvasEvent.DIRTY_RECTANGLE,{dirtyRect:{x:T,y:C,width:N,height:L}})),i.searchDirtyObjects(v).sort((function(e,t){return e.sortable.renderOrder-t.sortable.renderOrder})).forEach((function(e){e&&e.isVisible()&&!e.isCulled()&&i.renderDisplayObject(e,s,i.context,i.restoreStack,n)})),s.restore(),i.renderQueue.forEach((function(e){i.saveDirtyAABB(e)})),i.renderQueue=[]}i.restoreStack.forEach((function(){s.restore()})),i.restoreStack=[]}else i.clearFullScreenLastFrame=!0})),s.hooks.render.tap(e.tag,(function(e){i.clearFullScreen||i.renderQueue.push(e)}))},e.prototype.clearRect=function(e,t,r,n,i,o){e.clearRect(t,r,n,i),o&&(e.fillStyle=o,e.fillRect(t,r,n,i))},e.prototype.renderDisplayObject=function(e,r,n,i,o){var a=e.nodeName,l=i[i.length-1];!l||e.compareDocumentPosition(l)&t.Node.DOCUMENT_POSITION_CONTAINS||(r.restore(),i.pop());var s=this.context.styleRendererFactory[a],c=this.pathGeneratorFactory[a],h=e.parsedStyle.clipPath;if(h){this.applyWorldTransform(r,h);var d=this.pathGeneratorFactory[h.nodeName];d&&(r.save(),i.push(e),r.beginPath(),d(r,h.parsedStyle),r.closePath(),r.clip())}s&&(this.applyWorldTransform(r,e),r.save(),this.applyAttributesToContext(r,e)),c&&(r.beginPath(),c(r,e.parsedStyle),e.nodeName!==t.Shape.LINE&&e.nodeName!==t.Shape.PATH&&e.nodeName!==t.Shape.POLYLINE&&r.closePath()),s&&(s.render(r,e.parsedStyle,e,n,this,o),r.restore()),e.renderable.dirty=!1},e.prototype.convertAABB2Rect=function(e){var t=e.getMin(),r=e.getMax(),n=Math.floor(t[0]),i=Math.floor(t[1]);return{x:n,y:i,width:Math.ceil(r[0])-n,height:Math.ceil(r[1])-i}},e.prototype.mergeDirtyAABBs=function(e){var r=new t.AABB;return e.forEach((function(e){var t=e.getRenderBounds();r.add(t);var n=e.renderable.dirtyRenderBounds;n&&r.add(n)})),r},e.prototype.searchDirtyObjects=function(e){var t=o(e.getMin(),2),r=t[0],n=t[1],i=o(e.getMax(),2);return this.rBush.search({minX:r,minY:n,maxX:i[0],maxY:i[1]}).map((function(e){return e.displayObject}))},e.prototype.saveDirtyAABB=function(e){var r=e.renderable;r.dirtyRenderBounds||(r.dirtyRenderBounds=new t.AABB);var n=e.getRenderBounds();n&&r.dirtyRenderBounds.update(n.center,n.halfExtents)},e.prototype.applyAttributesToContext=function(e,t){var r=t.parsedStyle,n=r.stroke,i=r.fill,o=r.opacity,l=r.lineDash,s=r.lineDashOffset;l&&e.setLineDash(l),a(s)||(e.lineDashOffset=s),a(o)||(e.globalAlpha*=o),a(n)||Array.isArray(n)||n.isNone||(e.strokeStyle=t.attributes.stroke),a(i)||Array.isArray(i)||i.isNone||(e.fillStyle=t.attributes.fill)},e.prototype.applyWorldTransform=function(e,t,r){r?(d(this.tmpMat4,t.getLocalTransform()),u(this.tmpMat4,r,this.tmpMat4),u(this.tmpMat4,this.vpMatrix,this.tmpMat4)):(d(this.tmpMat4,t.getWorldTransform()),u(this.tmpMat4,this.vpMatrix,this.tmpMat4)),e.setTransform(this.tmpMat4[0],this.tmpMat4[1],this.tmpMat4[4],this.tmpMat4[5],this.tmpMat4[12],this.tmpMat4[13])},e.prototype.safeMergeAABB=function(){for(var e=[],r=0;arguments.length>r;r++)e[r]=arguments[r];var n=new t.AABB;return e.forEach((function(e){n.add(e)})),n},e.tag="CanvasRenderer",e}(),y=function(){function e(e){this.imagePool=e}return e.prototype.render=function(e,r,n,i,o,l){var s=r.fill,c=r.fillRule,h=r.opacity,d=void 0===h?1:h,u=r.fillOpacity,p=void 0===u?1:u,f=r.stroke,v=r.strokeOpacity,y=void 0===v?1:v,m=r.lineWidth,A=void 0===m?1:m,S=r.lineCap,B=r.lineJoin,M=r.shadowType,R=r.shadowBlur,w=r.filter,O=r.miterLimit,E=s&&!s.isNone,P=f&&!f.isNone&&A>0,T=0===(null==s?void 0:s.alpha),C=!(!w||!w.length),N=!a(r.shadowColor)&&R>0,L=n.nodeName,F="inner"===M,k=P&&N&&(L===t.Shape.PATH||L===t.Shape.LINE||L===t.Shape.POLYLINE||T||F);E&&(e.globalAlpha=d*p,k||g(n,e,N),x(e,n,s,c,i,o,l,this.imagePool),k||this.clearShadowAndFilter(e,C,N)),P&&(e.globalAlpha=d*y,e.lineWidth=A,a(O)||(e.miterLimit=O),a(S)||(e.lineCap=S),a(B)||(e.lineJoin=B),k&&(F&&(e.globalCompositeOperation="source-atop"),g(n,e,!0),F&&(b(e,n,f,i,o,l,this.imagePool),e.globalCompositeOperation="source-over",this.clearShadowAndFilter(e,C,!0))),b(e,n,f,i,o,l,this.imagePool))},e.prototype.clearShadowAndFilter=function(e,t,r){if(r&&(e.shadowColor="transparent",e.shadowBlur=0),t){var n=e.filter;!a(n)&&n.indexOf("drop-shadow")>-1&&(e.filter=n.replace(/drop-shadow\([^)]*\)/,"").trim()||"none")}},e}();function g(e,t,r){var n=e.parsedStyle,i=n.filter,o=n.shadowColor,a=n.shadowBlur,l=n.shadowOffsetX,s=n.shadowOffsetY;i&&i.length&&(t.filter=e.style.filter),r&&(t.shadowColor=""+o,t.shadowBlur=a||0,t.shadowOffsetX=l||0,t.shadowOffsetY=s||0)}function m(e,t,r,n,i,o,a){var l,s;if("rect"===e.image.nodeName){var c=e.image.parsedStyle,h=c.width,d=c.height;s=n.contextService.getDPR();var u=n.config.offscreenCanvas;(l=o.offscreenCanvasCreator.getOrCreateCanvas(u)).width=h*s,l.height=d*s;var p=o.offscreenCanvasCreator.getOrCreateContext(u),f=[];e.image.forEach((function(e){i.renderDisplayObject(e,p,n,f,o)})),f.forEach((function(){p.restore()}))}return a.getOrCreatePatternSync(e,r,l,s,t.getGeometryBounds().min,(function(){t.renderable.dirty=!0,n.renderingService.dirtify()}))}function A(e,r,n,o){var a;if(e.type===t.GradientType.LinearGradient||e.type===t.GradientType.RadialGradient){var l=r.getGeometryBounds(),s=l&&2*l.halfExtents[0]||1,c=l&&2*l.halfExtents[1]||1,h=l&&l.min||[0,0];a=o.getOrCreateGradient(i(i({type:e.type},e.value),{min:h,width:s,height:c}),n)}return a}function x(e,r,n,i,o,a,l,s,c){void 0===c&&(c=!1),Array.isArray(n)?n.forEach((function(t){e.fillStyle=A(t,r,e,s),c||(i?e.fill(i):e.fill())})):(t.isPattern(n)&&(e.fillStyle=m(n,r,e,o,a,l,s)),c||(i?e.fill(i):e.fill()))}function b(e,r,n,i,o,a,l,s){void 0===s&&(s=!1),Array.isArray(n)?n.forEach((function(t){e.strokeStyle=A(t,r,e,l),s||e.stroke()})):(t.isPattern(n)&&(e.strokeStyle=m(n,r,e,i,o,a,l)),s||e.stroke())}var S=function(){function e(e){this.imagePool=e}return e.prototype.render=function(e,t,r){var n,i=t.x,o=void 0===i?0:i,l=t.y,c=void 0===l?0:l,h=t.src,d=t.shadowColor,u=t.shadowBlur,p=t.width,f=t.height;if(s(h,"String")?n=this.imagePool.getImageSync(h):(p||(p=h.width),f||(f=h.height),n=h),n){g(r,e,!a(d)&&u>0);try{e.drawImage(n,o,c,p,f)}catch(e){}}},e}(),B=function(){function e(e){this.imagePool=e}return e.prototype.render=function(e,t,r,n,i,o){r.getBounds();var l=t.lineWidth,s=void 0===l?1:l,c=t.textAlign,h=void 0===c?"start":c,d=t.textBaseline,u=void 0===d?"alphabetic":d,p=t.lineJoin,f=void 0===p?"miter":p,v=t.miterLimit,y=void 0===v?10:v,m=t.letterSpacing,A=void 0===m?0:m,x=t.stroke,b=t.fill,S=t.fillRule,B=t.fillOpacity,M=void 0===B?1:B,R=t.strokeOpacity,w=void 0===R?1:R,O=t.opacity,E=void 0===O?1:O,P=t.metrics,T=t.x,C=void 0===T?0:T,N=t.y,L=void 0===N?0:N,F=t.dx,k=t.dy,D=t.shadowColor,G=t.shadowBlur,j=P.lines,I=P.height,Y=P.lineHeight,_=P.lineMetrics;e.font=P.font,e.lineWidth=s,e.textAlign="middle"===h?"center":h;var U=u;o.enableCSSParsing||"alphabetic"!==U||(U="bottom"),e.lineJoin=f,a(y)||(e.miterLimit=y);var W=L;"middle"===u?W+=-I/2-Y/2:"bottom"===u||"alphabetic"===u||"ideographic"===u?W+=-I:"top"!==u&&"hanging"!==u||(W+=-Y);var Q=C+(F||0);W+=k||0,1===j.length&&("bottom"===U?(U="middle",W-=.5*I):"top"===U&&(U="middle",W+=.5*I)),e.textBaseline=U,g(r,e,!a(D)&&G>0);for(var X=0;j.length>X;X++){var H=s/2+Q;W+=Y,a(x)||x.isNone||!s||this.drawLetterSpacing(e,r,j[X],_[X],h,H,W,A,b,S,M,x,w,E,!0,n,i,o),a(b)||this.drawLetterSpacing(e,r,j[X],_[X],h,H,W,A,b,S,M,x,w,E,!1,n,i,o)}},e.prototype.drawLetterSpacing=function(e,t,r,n,i,o,a,l,s,c,h,d,u,p,f,v,y,g){if(0!==l){var m=e.textAlign;e.textAlign="left";var A=o;"center"===i||"middle"===i?A=o-n.width/2:"right"!==i&&"end"!==i||(A=o-n.width);for(var x=Array.from(r),b=e.measureText(r).width,S=0,B=0;x.length>B;++B){var M=x[B];f?this.strokeText(e,t,M,A,a,d,u,v,y,g):this.fillText(e,t,M,A,a,s,c,h,p,v,y,g),A+=b-(S=e.measureText(r.substring(B+1)).width)+l,b=S}e.textAlign=m}else f?this.strokeText(e,t,r,o,a,d,u,v,y,g):this.fillText(e,t,r,o,a,s,c,h,p,v,y,g)},e.prototype.fillText=function(e,t,r,n,i,o,l,s,c,h,d,u){var p;x(e,t,o,l,h,d,u,this.imagePool,!0);var f=!a(s)&&1!==s;f&&(p=e.globalAlpha,e.globalAlpha=s*c),e.fillText(r,n,i),f&&(e.globalAlpha=p)},e.prototype.strokeText=function(e,t,r,n,i,o,l,s,c,h){var d;b(e,t,o,s,c,h,this.imagePool,!0);var u=!a(l)&&1!==l;u&&(d=e.globalAlpha,e.globalAlpha=l),e.strokeText(r,n,i),u&&(e.globalAlpha=d)},e}(),M=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(y),R=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(y),w=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(y),O=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(y),E=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(y),P=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(y),T=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(y),C=function(e){function r(t){void 0===t&&(t={});var r=e.call(this)||this;return r.options=t,r.name="canvas-renderer",r}return n(r,e),r.prototype.init=function(){var e,r=i({dirtyObjectNumThreshold:500,dirtyObjectRatioThreshold:.8},this.options),n=this.context.imagePool,o=new y(n),a=((e={})[t.Shape.CIRCLE]=o,e[t.Shape.ELLIPSE]=o,e[t.Shape.RECT]=o,e[t.Shape.IMAGE]=new S(n),e[t.Shape.TEXT]=new B(n),e[t.Shape.LINE]=o,e[t.Shape.POLYLINE]=o,e[t.Shape.POLYGON]=o,e[t.Shape.PATH]=o,e[t.Shape.GROUP]=void 0,e[t.Shape.HTML]=void 0,e[t.Shape.MESH]=void 0,e);this.context.defaultStyleRendererFactory=a,this.context.styleRendererFactory=a,this.addRenderingPlugin(new v(r))},r.prototype.destroy=function(){this.removeAllRenderingPlugins(),delete this.context.defaultStyleRendererFactory,delete this.context.styleRendererFactory},r}(t.AbstractRendererPlugin);e.CircleRenderer=R,e.EllipseRenderer=w,e.ImageRenderer=S,e.LineRenderer=O,e.PathRenderer=T,e.Plugin=C,e.PolygonRenderer=P,e.PolylineRenderer=E,e.RectRenderer=M,e.TextRenderer=B}));
//# sourceMappingURL=index.umd.min.js.map
