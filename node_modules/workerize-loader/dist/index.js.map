{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import path from 'path';\nimport loaderUtils from 'loader-utils';\n\nimport NodeTargetPlugin from 'webpack/lib/node/NodeTargetPlugin';\nimport SingleEntryPlugin from 'webpack/lib/SingleEntryPlugin';\nimport WebWorkerTemplatePlugin from 'webpack/lib/webworker/WebWorkerTemplatePlugin';\n\nexport default function loader() {}\n\nconst CACHE = {};\nconst tapName = 'workerize-loader';\n\nfunction compilationHook(compiler, handler) {\n\tif (compiler.hooks) {\n\t\treturn compiler.hooks.compilation.tap(tapName, handler);\n\t}\n\treturn compiler.plugin('compilation', handler);\n}\n\nfunction parseHook(data, handler) {\n\tif (data.normalModuleFactory.hooks) {\n\t\treturn data.normalModuleFactory.hooks.parser.for('javascript/auto').tap(tapName, handler);\n\t}\n\treturn data.normalModuleFactory.plugin('parser', handler);\n}\n\nfunction exportDeclarationHook(parser, handler) {\n\tif (parser.hooks) {\n\t\treturn parser.hooks.exportDeclaration.tap(tapName, handler);\n\t}\n\treturn parser.plugin('export declaration', handler);\n}\n\nloader.pitch = function(request) {\n\tthis.cacheable(false);\n\n\tconst options = loaderUtils.getOptions(this) || {};\n\n\tconst cb = this.async();\n\n\tconst compilerOptions = this._compiler.options || {};\n\n\tconst filename = (options.name || '[fullhash]') + '.worker.js';\n\n\tconst worker = {};\n\n\tworker.options = {\n\t\tfilename,\n\t\tchunkFilename: filename,\n\t\tpublicPath: options.publicPath || compilerOptions.output.publicPath,\n\t\tglobalObject: 'self'\n\t};\n\n\tif (compilerOptions.output && compilerOptions.output.globalObject==='window') {\n\t\tconsole.warn('Warning (workerize-loader): output.globalObject is set to \"window\". It should be set to \"self\" or \"this\" to support HMR in Workers.');\n\t}\n\n\tworker.compiler = this._compilation.createChildCompiler(`worker ${request}`, worker.options);\n\n\t(new WebWorkerTemplatePlugin(worker.options)).apply(worker.compiler);\n\n\tif (this.target!=='webworker' && this.target!=='web') {\n\t\t(new NodeTargetPlugin()).apply(worker.compiler);\n\t}\n\n\t// webpack >= v4 supports webassembly\n\tlet wasmPluginPath = null;\n\ttry {\n\t\twasmPluginPath = require.resolve(\n\t\t\t'webpack/lib/web/FetchCompileWasmTemplatePlugin'\n\t\t);\n\t}\n\tcatch (_err) {\n\t\t// webpack <= v3, skipping\n\t}\n\n\tif (wasmPluginPath) {\n\t\t// eslint-disable-next-line global-require\n\t\tconst FetchCompileWasmTemplatePlugin = require(wasmPluginPath);\n\t\tnew FetchCompileWasmTemplatePlugin({\n\t\t\tmangleImports: this._compiler.options.optimization.mangleWasmImports\n\t\t}).apply(worker.compiler);\n\t}\n\n\tconst bundleName = path.parse(this.resourcePath).name;\n\n\t(new SingleEntryPlugin(this.context, `!!${path.resolve(__dirname, 'rpc-worker-loader.js')}!${request}`, bundleName)).apply(worker.compiler);\n\n\tcompilationHook(worker.compiler, (compilation, data) => {\n\t\tparseHook(data, (parser, options) => {\n\t\t\texportDeclarationHook(parser, expr => {\n\t\t\t\tlet decl = expr.declaration || expr;\n\t\t\t\tlet\t{ compilation, current } = parser.state;\n\n\t\t\t\tlet entryModule =\n\t\t\t\t\tcompilation.entries instanceof Map\n\t\t\t\t\t\t? compilation.moduleGraph.getModule(\n\t\t\t\t\t\t\tcompilation.entries.get(bundleName).dependencies[0]\n\t\t\t\t\t\t  )\n\t\t\t\t\t\t: compilation.entries[0];\n\n\t\t\t\t// only process entry exports\n\t\t\t\tif (current.resource!==entryModule.resource) return;\n\n\t\t\t\tlet key = current.nameForCondition();\n\t\t\t\tlet exports = CACHE[key] || (CACHE[key] = {});\n\t\t\t\tif (decl.id) {\n\t\t\t\t\texports[decl.id.name] = true;\n\t\t\t\t}\n\t\t\t\telse if (decl.declarations) {\n\t\t\t\t\tfor (let i=0; i<decl.declarations.length; i++) {\n\t\t\t\t\t\texports[decl.declarations[i].id.name] = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tconsole.warn('[workerize] unknown export declaration: ', expr);\n\t\t\t\t}\n\n\t\t\t\t// This is for Webpack 5: mark the exports as used so it does not get tree-shaken away on production build\n\t\t\t\tif (compilation.moduleGraph) {\n\t\t\t\t\tconst { getEntryRuntime } = require('webpack/lib/util/runtime');\n\t\t\t\t\tconst { UsageState } = require('webpack');\n\t\t\t\t\tconst runtime = getEntryRuntime(compilation, bundleName);\n\t\t\t\t\tfor (const exportName of Object.keys(exports)) {\n\t\t\t\t\t\tconst exportInfo = compilation.moduleGraph.getExportInfo(entryModule, exportName);\n\t\t\t\t\t\texportInfo.setUsed(UsageState.Used, runtime);\n\t\t\t\t\t\texportInfo.canMangleUse = false;\n\t\t\t\t\t\texportInfo.canMangleProvide = false;\n\t\t\t\t\t}\n\t\t\t\t\tcompilation.moduleGraph.addExtraReason(entryModule, 'used by workerize-loader');\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t});\n\n\tworker.compiler.runAsChild((err, entries, compilation) => {\n\t\tif (err) return cb(err);\n\n\t\tif (entries[0]) {\n\t\t\tworker.file = Array.from(entries[0].files)[0];\n\t\t\tconst entryModules =\n\t\t\t\tcompilation.chunkGraph &&\n\t\t\t\tcompilation.chunkGraph.getChunkEntryModulesIterable\n\t\t\t\t\t? Array.from(\n\t\t\t\t\t\tcompilation.chunkGraph.getChunkEntryModulesIterable(entries[0])\n\t\t\t\t\t  )\n\t\t\t\t\t: null;\n\t\t\tconst entryModule =\n\t\t\t\tentryModules && entryModules.length > 0\n\t\t\t\t\t? entryModules[0]\n\t\t\t\t\t: entries[0].entryModule;\n\n\t\t\tlet key = entryModule.nameForCondition();\n\t\t\tlet contents = compilation.assets[worker.file].source();\n\t\t\tlet exports = Object.keys(CACHE[key] || {});\n\n\t\t\t// console.log('Workerized exports: ', exports.join(', '));\n\n\t\t\tif (options.inline) {\n\t\t\t\tworker.url = `URL.createObjectURL(new Blob([${JSON.stringify(contents)}]))`;\n\t\t\t}\n\t\t\telse if (options.publicPath) {\n\t\t\t\tworker.url = `${JSON.stringify(options.publicPath + worker.file)}`;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tworker.url = `__webpack_public_path__ + ${JSON.stringify(worker.file)}`;\n\t\t\t}\n\n\t\t\tif (options.fallback === false) {\n\t\t\t\tdelete this._compilation.assets[worker.file];\n\t\t\t}\n\n\t\t\tlet workerUrl = worker.url;\n\t\t\tif (options.import) {\n\t\t\t\tworkerUrl = `\"data:,importScripts('\"+new URL(${workerUrl},location.origin)+\"')\"`;\n\t\t\t}\n\n\t\t\t// workerUrl will be URL.revokeObjectURL() to avoid memory leaks on browsers\n\t\t\t// https://github.com/webpack-contrib/worker-loader/issues/208\n\n\t\t\treturn cb(null, `\n\t\t\t\tvar addMethods = require(${loaderUtils.stringifyRequest(this, path.resolve(__dirname, 'rpc-wrapper.js'))})\n\t\t\t\tvar methods = ${JSON.stringify(exports)}\n\t\t\t\tmodule.exports = function() {\n\t\t\t\t\tvar w = new Worker(${workerUrl}, { name: ${JSON.stringify(filename)} })\n\t\t\t\t\tURL.revokeObjectURL(${workerUrl});\n\t\t\t\t\taddMethods(w, methods)\n\t\t\t\t\t${ options.ready ? 'w.ready = new Promise(function(r) { w.addEventListener(\"ready\", function(){ r(w) }) })' : '' }\n\t\t\t\t\treturn w\n\t\t\t\t}\n\t\t\t`);\n\t\t}\n\n\t\treturn cb(null, null);\n\t});\n};\n"],"names":["loader","CACHE","tapName","compilationHook","compiler","handler","hooks","compilation","tap","plugin","parseHook","data","normalModuleFactory","parser","for","exportDeclarationHook","exportDeclaration","pitch","request","cacheable","options","loaderUtils","getOptions","cb","async","compilerOptions","_compiler","filename","name","worker","chunkFilename","publicPath","output","globalObject","console","warn","_compilation","createChildCompiler","WebWorkerTemplatePlugin","apply","target","NodeTargetPlugin","wasmPluginPath","require","resolve","_err","FetchCompileWasmTemplatePlugin","mangleImports","optimization","mangleWasmImports","bundleName","path","parse","resourcePath","SingleEntryPlugin","context","__dirname","expr","decl","declaration","state","current","entryModule","entries","Map","moduleGraph","getModule","get","dependencies","resource","key","nameForCondition","exports","id","declarations","i","length","getEntryRuntime","UsageState","runtime","Object","keys","exportName","exportInfo","getExportInfo","setUsed","Used","canMangleUse","canMangleProvide","addExtraReason","runAsChild","err","file","Array","from","files","entryModules","chunkGraph","getChunkEntryModulesIterable","contents","assets","source","inline","url","JSON","stringify","fallback","workerUrl","import","stringifyRequest","ready"],"mappings":"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"}